var AdminDayTaskCreator=function(){function n(n){this.AssigneeUserId=n.AssigneeUserId;this.TaskDate=""}return n.prototype.SetDate=function(n){var t=n.split(".");n=t[1]+"."+t[0]+"."+t[2];this.TaskDate=n},n.prototype.ProccessData=function(n){return n.AssigneeUserId=this.AssigneeUserId,n.TaskDate=this.TaskDate,n},n.prototype.CreateDayTask=function(n){n=this.ProccessData(n);Requester.SendPostRequestWithAnimation("/Api/DayTask/CreateOrUpdate",n,function(n){n.IsSucceeded&&DayTasksWorker.GetTasks()},null)},n.prototype.EditDayTask=function(n){Requester.SendPostRequestWithAnimation("/Api/DayTask/CreateOrUpdate",n,function(n){n.IsSucceeded&&DayTasksWorker.GetTasks()},null)},n}(),ColorAvatarInitor=function(){function n(){}return n._avatarsStorage=[],n._colors=["#007bff","#6610f2","#6f42c1","#e83e8c","#dc3545","#fd7e14","#ffc107","#28a745","#20c997","#17a2b8","#fff","#6c757d"],n.InitColorForAvatar=function(t){var i,r,u;return t.AssigneeUser.AvatarFileId===null?(i=!1,r="",n._avatarsStorage.forEach(function(n){n.id==t.AssigneeUser.Id&&(i=!0,r=n.color)}),i?"<span class='avatar-circle' style='background-color:"+r+"'><\/span>":(u=n._avatarsStorage.length%n._colors.length,n._avatarsStorage.push({id:t.AssigneeUser.Id,color:n._colors[u+1]}),"<span class='avatar-circle' style='background-color:"+n._colors[u+1]+"'><\/span>")):"<img style='height:30px;width:30px' class='rounded-circle' src='/FileCopies/Images/Icon/"+t.AssigneeUser.AvatarFileId+".jpg'/>"},n}(),DayTaskDrawer=function(){function n(){}return n.prototype.DrawTasks=function(n,t){var i,r;for(this.ClearTasks(),i=0;i<n.length;i++)r=n[i],this.AddTaskToDate(r);t&&this.AddAdminActions();ScheduleStaticHandlers.SetHandlers()},n.prototype.AddTaskToDate=function(n){var r=moment(n.TaskDate).format("DD.MM.YYYY"),i=document.querySelector("[data-date='"+r+"']"),t;$(i).children(".no-tasks-text").hide();t=document.createElement("div");t.innerHTML='<a class="event d-block p-1 pl-2 pr-2 mb-1 rounded text-truncate small bg-primary text-white tms-show-task-modal" data-task-id="'+n.Id+'" title="'+n.TaskTitle+'">\n                                        '+n.TaskTitle+'\n                                        <span class="float-right" data-toggle="tooltip" data-placement="top" title="'+n.AssigneeUser.Email+'">\n                                            '+ColorAvatarInitor.InitColorForAvatar(n)+"\n                                        <\/span>\n                                   <\/a>";i.appendChild(t)},n.prototype.AddAdminActions=function(){var t=document.getElementById("createTaskBtn"),n;t.innerHTML="";n=document.createElement("div");n.innerHTML='<a class="btn float-right pl-2 pr-2 mb-1 rounded text-truncate bg-success text-white d-none d-lg-inline tms-btn-create-task">\n                        <i class="fas fa-plus-circle fa-fw" style="font-size: 0.8rem;"><\/i> Создать задание\n                    <\/a>\n                    <a class="btn float-right pl-2 pr-2 mb-1 rounded text-truncate bg-success text-white  d-inline d-lg-none tms-btn-create-task">\n                        <i class="fas fa-plus-circle fa-fw" style="font-size: 0.8rem;"><\/i> Создать\n                    <\/a>';t.appendChild(n)},n.prototype.ClearTasks=function(){for(var n=document.getElementsByClassName("event");n[0];)n[0].parentNode.removeChild(n[0])},n}(),DayTaskEditor=function(){function n(){}return n.UpdateHtmlProperties=function(n){ModalWorker.ShowModal("loadingModal");Requester.SendPostRequestWithAnimation("/Api/DayTask/CreateOrUpdate",n,function(n){n.IsSucceeded&&DayTasksWorker.GetTasks()},null)},n}(),DayTasksWorker=function(){function n(){}return n.Constructor=function(n){this.Tasks=n.Tasks;this.IsAdmin=n.IsAdmin;this.User=n.User;this.SearchModel=n.SearchModel;this.OpenTaskId=n.OpenTaskId;this.MyUserId=n.MyUserId;this.CurrentTaskId=null;this.CurrentTask=null;this.Drawer=new DayTaskDrawer},n.OpenTaskById=function(){var i=this.OpenTaskId,t=n.Tasks.find(function(n){return n.Id===i});t!=null&&ScheduleStaticHandlers.ShowDayTaskModal(t.Id)},n.SetCurrentTaskId=function(t){this.CurrentTaskId=t;this.CurrentTask=n.Tasks.find(function(n){return n.Id===t})},n.SendNotificationToAdmin=function(){ModalWorker.ShowModal("loadingModal");Requester.SendPostRequestWithAnimation("/Api/DayTask/SendToAdmin",{Id:n.CurrentTaskId},function(n){return alert(n)},null)},n.GetTasks=function(){var t=this;Requester.SendAjaxPost("/Api/DayTask/GetTasks",this.SearchModel,function(i){t.Tasks=i;t.Drawer.DrawTasks(n.Tasks,!0);t.OpenTaskById()},null,!1)},n.GetTaskById=function(t){return n.Tasks.find(function(n){return n.Id===t})},n}(),ScheduleConsts=function(){function n(){}return n.FilterPrefix="filter.",n}(),ScheduleStaticHandlers=function(){function n(){}return n.SetHandlers=function(){EventSetter.SetHandlerForClass("tms-next-month-btn","click",function(){return n.ApplyFilter(!0)});EventSetter.SetHandlerForClass("tms-prev-month-btn","click",function(){return n.ApplyFilter(!1)});EventSetter.SetHandlerForClass("tms-add-comment-btn","click",function(){return n.addComment()});EventSetter.SetHandlerForClass("tms-update-comment-btn","click",function(t){var i=t.target.getAttribute("data-comment-id");n.updateComment(i)});EventSetter.SetHandlerForClass("tms-profile-link","click",function(t){var i=t.target.getAttribute("data-task-author-id");n.redirectToProfile(i)});EventSetter.SetHandlerForClass("tms-update-task-btn","click",function(){n.updateDayTask();ModalWorker.HideModals()});EventSetter.SetHandlerForClass("tms-redirect-to-full","click",function(){return n.redirectToFullVersion()});EventSetter.SetHandlerForClass("tms-create-task-btn","click",function(){return n.createDayTask()});EventSetter.SetHandlerForClass("tms-btn-create-task","click",function(){return n.ShowCreateTaskModal()});EventSetter.SetHandlerForClass("tms-show-task-modal","click",function(t){var i=$(t.target).data("task-id");n.ShowDayTaskModal(i)})},n.GetQueryParams=function(t){var i={UserIds:[]},r=FormDataHelper.CollectDataByPrefix(i,ScheduleConsts.FilterPrefix);return r.MonthShift=t?n.Filter.MonthShift+1:n.Filter.MonthShift-1,Requester.GetParams(i)},n.ApplyFilter=function(t){location.href="/Schedule/Index?"+n.GetQueryParams(t)},n.OnUsersSelectChanged=function(){n._countOfChanges++;n._countOfChanges>1&&n.ShowUserSchedule()},n.ShowUserSchedule=function(){var n=FormDataHelper.CollectDataByPrefix({UserIds:[]},ScheduleConsts.FilterPrefix);location.href="/Schedule/Index?"+Requester.GetParams(n)},n.ShowDayTaskModal=function(n){DayTasksWorker.SetCurrentTaskId(n);var t=DayTasksWorker.GetTaskById(n);TaskModalWorker.ShowDayTaskModal(t)},n.ShowCreateTaskModal=function(){FormDataHelper.FillDataByPrefix({TaskDate:"",TaskText:"",TaskTitle:""},"create.");Utils.SetDatePicker("input[name='create.TaskDate']","0");ModalWorker.ShowModal("createDayTaskModal")},n.updateComment=function(n){var t={Comment:""},i;t=FormDataHelper.CollectDataByPrefix(t,"edit.");i={Comment:t.Comment,DayTaskCommentId:n};Requester.SendAjaxPost("/Api/DayTask/Comments/Update",i,function(n){n.IsSucceeded&&(TaskModalWorker.DrawComments("Comments",n.ResponseObject),DayTasksWorker.GetTasks())},null,!1)},n.addComment=function(){var n={DayTaskId:"",Comment:""};n=FormDataHelper.CollectData(n);Requester.SendAjaxPost("/Api/DayTask/Comments/Add",n,function(n){n.IsSucceeded&&(TaskModalWorker.DrawComments("Comments",n.ResponseObject),DayTasksWorker.GetTasks())},null,!1)},n.redirectToFullVersion=function(){var n={Id:""};n=FormDataHelper.CollectDataByPrefix(n,"task.");window.open(window.location.origin+"/Schedule/Task/"+n.Id,"_blank")},n.updateDayTask=function(){var n={TaskText:"",TaskTitle:"",AssigneeUserId:"",Id:"",TaskComment:"",TaskDate:new Date,TaskReview:"",TaskTarget:""};n=FormDataHelper.CollectDataByPrefix(n,"task.");n.TaskDate=Utils.GetDateFromDatePicker("TaskDate");Requester.SendAjaxPost("/Api/DayTask/CreateOrUpdate",n,function(n){n.IsSucceeded&&DayTasksWorker.GetTasks()},null,!1)},n.createDayTask=function(){var t={Id:"",TaskText:"",TaskTitle:"",AssigneeUserId:"",TaskComment:"",TaskDate:new Date,TaskReview:"",TaskTarget:""};t=FormDataHelper.CollectDataByPrefix(t,"create.");t.TaskDate=Utils.GetDateFromDatePicker("TaskDate1");Requester.SendAjaxPost("/Api/DayTask/CreateOrUpdate",t,function(t){ToastrWorker.HandleBaseApiResponse(t);t.IsSucceeded&&n.hideCreateModal()},null,!1)},n.hideCreateModal=function(){$("#createDayTaskModal").modal("hide");DayTasksWorker.GetTasks()},n.redirectToProfile=function(n){window.open(window.location.origin+"/Client/Details/"+n,"_blank")},n._countOfChanges=0,n}();ScheduleStaticHandlers.SetHandlers();var ScheduleWorker_Resx=function(){function n(){this.SelectUser="Выберите пользователя";this.UserNotFound="Пользователь не найден."}return n}(),ScheduleWorker=function(){function n(){}return n.Constructor=function(t){n.filter=t;n.SetUsersSelect();n.Users=[]},n.formatStateSelection=function(n){var t,i,r;return n.id?(t="",i=!1,n.avatarId&&(r="/FileCopies/Images/Icon/"+n.avatarId+".jpg",t=i?'<img src="'+r+'" class="img-max-50" />':""),$("<span>"+t+" "+n.text+"<span>&nbsp;<\/span><\/span>")):n.text},n.formatStateResult=function(n){var t,i,r;return n.id?(t="",i=!1,n.avatarId&&(r="/FileCopies/Images/Icon/"+n.avatarId+".jpg",t=i?'<img src="'+r+'" class="img-max-50" />':""),$("<span>"+t+" "+n.text+"<span>&nbsp;<\/span><\/span>")):n.text},n.SetUsersSelect=function(){var t=this;Requester.SendAjaxPost("/Api/User/Get",{Count:null,OffSet:0},function(i){n.Users=i.List;$("#usersSelect").select2({placeholder:n.Resources.SelectUser,language:{noResults:function(){return n.Resources.UserNotFound}},data:i.List.map(function(n){return{id:n.Id,text:n.Email,avatarId:n.AvatarFileId}}),templateSelection:n.formatStateSelection,templateResult:n.formatStateResult,escapeMarkup:function(n){return n}});FormDataHelper.FillDataByPrefix({UserIds:n.filter.UserIds},"filter.");$("#usersSelect").val(t.filter.UserIds).trigger("change.select2");$(".select2-selection__rendered img").addClass("m--img-rounded m--marginless m--img-centered")},null,!1)},n.Resources=new ScheduleWorker_Resx,n}(),TaskModalWorker=function(){function n(){}return n.ShowDayTaskModal=function(t){n.InitTask(t);FormDataHelper.FillDataByPrefix(t,"task.");Utils.SetDatePicker("input[name='task.TaskDate']");ModalWorker.ShowModal("dayTaskModal")},n.InitTask=function(t){t.TaskDate=moment(new Date(t.TaskDate)).format("DD/MM/YYYY");n.ClearContent();document.getElementById("dayTaskModalTitle").innerHTML=t.TaskTitle;var i=ColorAvatarInitor.InitColorForAvatar(t);document.getElementById("Author").innerHTML='<a class="media-left tms-profile-link" href="#" data-task-author-id="'+t.Author.Id+'">'+i+'<\/a>\n                <a  href="#" data-task-author-id="'+t.Author.Id+'" class="tms-profile-link text-semibold media-heading box-inline ml-1 mb-1">\n                    '+t.Author.Name+" "+t.Author.Email+"\n                <\/a>";document.getElementsByName("DayTaskId")[0].value=t.Id;$("#usersSelect1").val(t.AssigneeUser.Id).trigger("change.select2");n.DrawComments("Comments",t);$("#usersSelect1").select2({width:"100%"})},n.DrawComments=function(t,i){var r;n.ClearContent();var f=AccountWorker.User.Id,e=ColorAvatarInitor.InitColorForAvatar(i),u="<div>";for(r in i.Comments)u+='\n          <div class="media-block">\n            <div class="media-body">\n                <div class="form-group m-form__group row m--margin-top-10 d-flex justify-content-between align-items-center">\n                        <div>\n                            <a href="#" class="btn-link btn cursor-pointer tms-profile-link" data-task-author-id="'+i.Author.Id+'">\n                                '+e+'\n                            <\/a>\n                            <a href="#" data-task-author-id="'+i.Author.Id+'" class="text-semibold tms-profile-link">\n                                '+i.Comments[r].Author.Name+"\n                            <\/a>\n                        <\/div>",u+=i.Comments[r].Author.Id==f?'<div>\n                            <button style=\'height:30px; width:30px\' data-editable-name="btnEditComment" data-id="'+i.Comments[r].Id+'" class="float-right bg-white border-0" onclick="TaskModalWorker.MakeCommentFieldEditable(\''+i.Comments[r].Id+'\')">\n                                <i class="fa fa-pencil-square-o" aria-hidden="true"><\/i>\n                            <\/button>\n                        <\/div>\n                        <\/div>':"<\/div>",u+='<div id="'+i.Comments[r].Id+'">'+i.Comments[r].Comment+"<\/div>\n                        \n                    <\/div>\n                  <\/div>";u+="<\/div>";document.getElementById(t).innerHTML=u},n.ClearContent=function(){document.getElementsByName("Comment")[0].value="";document.getElementById("dayTaskModalTitle").innerHTML="";for(var n=document.getElementsByClassName("media-block");n[0];)n[0].remove()},n.MakeCommentFieldEditable=function(n){var t=document.getElementById(n).innerHTML;$("[data-editable-name='btnEditComment']").attr("hidden","hidden");document.getElementById(n).innerHTML='<textarea class="form-control" name="edit.Comment" rows="2">'+t+'<\/textarea>\n                <button class="btn btn-sm btn-editable float-right m-1" data-editable-cancel="'+n+'" \n                        onclick="TaskModalWorker.ResetCommentChanges(\''+n+"','"+t+'\')">\n                    <i class="fas fa-times"><\/i>\n                <\/button>\n\n                <button class="btn btn-sm btn-editable float-right mt-1 tms-update-comment-btn" data-comment-id="'+n+'">\n                    <i class="fas fa-check"><\/i>\n                <\/button>';document.querySelector('[data-id="'+n+'"]').setAttribute("hidden","hidden")},n.ResetCommentChanges=function(n,t){document.getElementById(""+n).innerHTML=""+t;$("[data-editable-name='btnEditComment']").removeAttr("hidden")},n}();