var ColorAvatarInitor=function(){function n(){}return n._avatarsStorage=[],n._colors=["#007bff","#6610f2","#6f42c1","#e83e8c","#dc3545","#fd7e14","#ffc107","#28a745","#20c997","#17a2b8","#fff","#6c757d"],n.InitColorForAvatar=function(t){var i,r,u;return t.AssigneeUser.AvatarFileId===null?(i=!1,r="",n._avatarsStorage.forEach(function(n){n.id==t.AssigneeUser.Id&&(i=!0,r=n.color)}),i?"<span class='avatar-circle' style='background-color:"+r+"'><\/span>":(u=n._avatarsStorage.length%n._colors.length,n._avatarsStorage.push({id:t.AssigneeUser.Id,color:n._colors[u+1]}),"<span class='avatar-circle' style='background-color:"+n._colors[u+1]+"'><\/span>")):"<img style='height:30px;width:30px' class='rounded-circle' src='/FileCopies/Images/Icon/"+t.AssigneeUser.AvatarFileId+".jpg'/>"},n}(),DayTaskDrawer=function(){function n(){}return n.prototype.DrawTasks=function(n){var t,i;if(n!=null){for(this.ClearTasks(),t=0;t<n.length;t++)i=n[t],this.AddTaskToDate(i);this.AddAdminActions();ScheduleStaticHandlers.SetHandlers()}},n.prototype.AddTaskToDate=function(n){var r=moment(n.TaskDate).format("DD.MM.YYYY"),i=document.querySelector("[data-date='"+r+"']"),t;$(i).children(".no-tasks-text").hide();t=document.createElement("div");t.innerHTML='<a class="event d-block p-1 pl-2 pr-2 mb-1 rounded text-truncate small bg-primary text-white tms-show-task-modal" data-task-id="'+n.Id+'" title="'+n.TaskTitle+'">\n                                        '+n.TaskTitle+'\n                                        <span class="float-right" data-toggle="tooltip" data-placement="top" title="'+n.AssigneeUser.Email+'">\n                                            '+ColorAvatarInitor.InitColorForAvatar(n)+"\n                                        <\/span>\n                                   <\/a>";i.appendChild(t)},n.prototype.AddAdminActions=function(){var t=document.getElementById("createTaskBtn"),n;t.innerHTML="";n=document.createElement("div");n.innerHTML='<a class="btn float-right pl-2 pr-2 mb-1 rounded text-truncate bg-success text-white d-none d-lg-inline tms-btn-create-task">\n                        <i class="fas fa-plus-circle fa-fw" style="font-size: 0.8rem;"><\/i> Создать задание\n                    <\/a>\n                    <a class="btn float-right pl-2 pr-2 mb-1 rounded text-truncate bg-success text-white  d-inline d-lg-none tms-btn-create-task">\n                        <i class="fas fa-plus-circle fa-fw" style="font-size: 0.8rem;"><\/i> Создать\n                    <\/a>';t.appendChild(n)},n.prototype.ClearTasks=function(){for(var n=document.getElementsByClassName("event");n[0];)n[0].parentNode.removeChild(n[0])},n}(),DayTaskEditor=function(){function n(){}return n.UpdateHtmlProperties=function(n){CrocoAppCore.Application.ModalWorker.ShowModal("loadingModal");CrocoAppCore.Application.Requester.SendPostRequestWithAnimation("/Api/DayTask/CreateOrUpdate",n,function(n){n.IsSucceeded&&DayTasksWorker.GetTasks()},null)},n}(),DayTasksWorker=function(){function n(){}return n.Constructor=function(n){this.Tasks=n.Tasks;this.IsAdmin=n.IsAdmin;this.User=n.User;this.SearchModel=n.SearchModel;this.OpenTaskId=n.OpenTaskId;this.MyUserId=n.MyUserId;this.CurrentTaskId=null;this.CurrentTask=null;this.Drawer=new DayTaskDrawer},n.OpenTaskById=function(){var i=this.OpenTaskId,t=n.Tasks.find(function(n){return n.Id===i});t!=null&&ScheduleStaticHandlers.ShowDayTaskModal(t.Id)},n.SetCurrentTaskId=function(t){this.CurrentTaskId=t;this.CurrentTask=n.Tasks.find(function(n){return n.Id===t});console.log("SetCurrentTaskId",this.CurrentTask)},n.SendNotificationToAdmin=function(){CrocoAppCore.Application.ModalWorker.ShowModal("loadingModal");CrocoAppCore.Application.Requester.SendPostRequestWithAnimation("/Api/DayTask/SendToAdmin",{Id:n.CurrentTaskId},function(n){return alert(n)},null)},n.GetTasks=function(){var t=this.SearchModel;t.MonthShift=+this.SearchModel.MonthShift;console.log("DayTasksWorker.GetTasks()",t,JSON.stringify(t));CrocoAppCore.Application.Requester.Post("/Api/DayTask/GetTasks",t,function(t){n.Tasks=t;n.Drawer.DrawTasks(t);n.OpenTaskById()},null)},n.GetTaskById=function(t){return n.Tasks.find(function(n){return n.Id===t})},n}(),ScheduleConsts=function(){function n(){}return n.FilterPrefix="filter.",n}(),ScheduleStaticHandlers=function(){function n(){}return n.SetInnerHandlers=function(){console.log("ScheduleStaticHandlers.SetInnerHandlers()");$(".tms-next-month-btn").on("click",function(){return n.RedirectToNewUserSchedule(1)});$(".tms-prev-month-btn").on("click",function(){return n.RedirectToNewUserSchedule(-1)});$(".tms-update-task-btn").unbind("click").on("click",function(){n.updateDayTask();CrocoAppCore.Application.ModalWorker.HideModals()});$(".tms-redirect-to-full").unbind("click").on("click",function(){return n.redirectToFullVersion()});$("#tms-create-task-btn").on("click",function(t){console.log("tms-create-task-btn click");t.preventDefault();t.stopPropagation();n.createDayTask()});$(document).on("click",".tms-profile-link",function(t){console.log("tms-profile-link clicked");var i=t.target.getAttribute("data-task-author-id");n.redirectToProfile(i)})},n.SetHandlers=function(){$(".tms-show-task-modal").unbind("click").click(function(t){t.preventDefault();t.stopPropagation();var i=$(t.target).data("task-id");n.ShowDayTaskModal(i)});$(".tms-btn-create-task").on("click",function(t){t.preventDefault();t.stopPropagation();n.ShowCreateTaskModal()})},n.OnUsersSelectChanged=function(){var t={UserIds:[]},i;CrocoAppCore.Application.FormDataHelper.CollectDataByPrefix(t,ScheduleConsts.FilterPrefix);i=n.Filter.UserIds==null?0:n.Filter.UserIds.length;t.UserIds.length!==i&&n.RedirectToNewUserSchedule(0)},n.RedirectToNewUserSchedule=function(t){var f,i,r,u,e;for(console.log("RedirectToNewUserSchedule",t),f={UserIds:[]},CrocoAppCore.Application.FormDataHelper.CollectDataByPrefix(f,ScheduleConsts.FilterPrefix),i={UserIds:f.UserIds,MonthShift:n.Filter.MonthShift+t},console.log("ShowUserSchedule.Data",i),r=[],u=0;u<i.UserIds.length;u++)r.push("UserIds="+i.UserIds[u]);i.MonthShift!==0&&r.push("MonthShift="+i.MonthShift);e="/Schedule/Index?"+r.join("&");console.log("ShowUserSchedule.Url",e);location.href=e},n.ShowDayTaskModal=function(n){DayTasksWorker.SetCurrentTaskId(n);var t=DayTasksWorker.GetTaskById(n);TaskModalWorker.ShowDayTaskModal(t)},n.ShowCreateTaskModal=function(){n.InitUserSelect("#usersSelect2");CrocoAppCore.Application.FormDataHelper.FillDataByPrefix({TaskDate:"",TaskText:"",TaskTitle:""},"create.");DatePickerUtils.SetDatePicker("TaskDate1","RealTaskDate1");CrocoAppCore.Application.ModalWorker.ShowModal("createDayTaskModal")},n.InitUserSelect=function(n){$(n).select2({placeholder:ScheduleWorker.Resources.SelectUser,language:{noResults:function(){return ScheduleWorker.Resources.UserNotFound}},data:ScheduleWorker.Users.map(function(n){return{id:n.Id,text:n.Email,avatarId:n.AvatarFileId}}),templateSelection:ScheduleWorker.formatStateSelection,templateResult:ScheduleWorker.formatStateResult,escapeMarkup:function(n){return n}})},n.redirectToFullVersion=function(){var n={Id:""};CrocoAppCore.Application.FormDataHelper.CollectDataByPrefix(n,"task.");window.open(window.location.origin+"/Schedule/Task/"+n.Id,"_blank")},n.updateDayTask=function(){var n={TaskText:"",TaskTitle:"",AssigneeUserId:"",Id:"",TaskComment:"",TaskDate:new Date,TaskReview:"",TaskTarget:""};CrocoAppCore.Application.FormDataHelper.CollectDataByPrefix(n,"task.");n.TaskDate=DatePickerUtils.GetDateFromDatePicker("TaskDate");CrocoAppCore.Application.Requester.Post("/Api/DayTask/CreateOrUpdate",n,function(n){n.IsSucceeded&&DayTasksWorker.GetTasks()},null)},n.createDayTask=function(){var t={Id:"",TaskText:"",TaskTitle:"",AssigneeUserId:"",TaskComment:"",TaskDate:new Date,TaskReview:"",TaskTarget:""};if(CrocoAppCore.Application.FormDataHelper.CollectDataByPrefix(t,"create."),document.getElementById("TaskDate1").value===""){Requester.OnSuccessAnimationHandler({IsSucceeded:!1,Message:"Необходимо указать дату задания"});return}t.TaskDate=DatePickerUtils.GetDateFromDatePicker("TaskDate1");console.log("createDayTask",t);CrocoAppCore.Application.Requester.SendPostRequestWithAnimation("/Api/DayTask/CreateOrUpdate",t,function(t){t.IsSucceeded&&n.hideCreateModal()},null)},n.hideCreateModal=function(){$("#createDayTaskModal").modal("hide");DayTasksWorker.GetTasks()},n.redirectToProfile=function(n){window.open(window.location.origin+"/Client/Details/"+n,"_blank")},n}();ScheduleStaticHandlers.SetInnerHandlers();ScheduleStaticHandlers.SetHandlers();var ScheduleWorker_Resx=function(){function n(){this.SelectUser="Выберите пользователя";this.UserNotFound="Пользователь не найден."}return n}(),ScheduleWorker=function(){function n(){}return n.Constructor=function(t){n.filter=t;n.SetUsersSelect()},n.formatStateSelection=function(n){var t,i,r;return n.id?(t="",i=!1,n.avatarId&&(r="/FileCopies/Images/Icon/"+n.avatarId+".jpg",t=i?'<img src="'+r+'" class="img-max-50" />':""),$("<span>"+t+" "+n.text+"<span>&nbsp;<\/span><\/span>")):n.text},n.formatStateResult=function(n){var t,i,r;return n.id?(t="",i=!1,n.avatarId&&(r="/FileCopies/Images/Icon/"+n.avatarId+".jpg",t=i?'<img src="'+r+'" class="img-max-50" />':""),$("<span>"+t+" "+n.text+"<span>&nbsp;<\/span><\/span>")):n.text},n.SetUsersSelect=function(){var t=this;CrocoAppCore.Application.Requester.Post("/Api/User/Get",{Count:null,OffSet:0},function(i){n.Users=i.List;$("#usersSelect").select2({placeholder:n.Resources.SelectUser,language:{noResults:function(){return n.Resources.UserNotFound}},data:i.List.map(function(n){return{id:n.Id,text:n.Email,avatarId:n.AvatarFileId}}),templateSelection:n.formatStateSelection,templateResult:n.formatStateResult,escapeMarkup:function(n){return n}});CrocoAppCore.Application.FormDataHelper.FillDataByPrefix({UserIds:n.filter.UserIds},"filter.");$("#usersSelect").val(t.filter.UserIds).trigger("change.select2");$(".select2-selection__rendered img").addClass("m--img-rounded m--marginless m--img-centered")},null)},n.Users=[],n.Resources=new ScheduleWorker_Resx,n}(),TaskModalConsts=function(){function n(){}return n.UserSelectId="usersSelect1",n}(),TaskModalWorker=function(){function n(){}return n.ShowDayTaskModal=function(t){n.InitTask(t);CrocoAppCore.Application.FormDataHelper.FillDataByPrefix(t,"task.");DatePickerUtils.SetDatePicker("TaskDate","RealTaskDate");DatePickerUtils.SetDateToDatePicker("TaskDate",t.TaskDate);var i="#"+TaskModalConsts.UserSelectId;ScheduleStaticHandlers.InitUserSelect(i);$(i).val(t.AssigneeUser.Id).trigger("change");CrocoAppCore.Application.ModalWorker.ShowModal("dayTaskModal")},n.InitTask=function(t){t.TaskDate=moment(new Date(t.TaskDate)).format("DD/MM/YYYY");n.ClearContent();document.getElementById("dayTaskModalTitle").innerHTML=t.TaskTitle;var i=ColorAvatarInitor.InitColorForAvatar(t);document.getElementById("Author").innerHTML='<a class="media-left tms-profile-link" data-task-author-id="'+t.Author.Id+'">'+i+'<\/a>\n                <a data-task-author-id="'+t.Author.Id+'" class="tms-profile-link text-semibold media-heading box-inline ml-1 mb-1">\n                    '+t.Author.Name+" "+t.Author.Email+"\n                <\/a>";document.getElementsByName("DayTaskId")[0].value=t.Id;$("#usersSelect1").val(t.AssigneeUser.Id).trigger("change.select2");n.DrawComments("Comments",t);$("#usersSelect1").select2({width:"100%"})},n.DrawComments=function(t,i){var r;n.ClearContent();var f=AccountWorker.User.Id,e=ColorAvatarInitor.InitColorForAvatar(i),u="<div>";for(r in i.Comments)u+='\n          <div class="media-block">\n            <div class="media-body">\n                <div class="form-group m-form__group row m--margin-top-10 d-flex justify-content-between align-items-center">\n                        <div>\n                            <a href="#" class="btn-link btn cursor-pointer tms-profile-link" data-task-author-id="'+i.Author.Id+'">\n                                '+e+'\n                            <\/a>\n                            <a href="#" data-task-author-id="'+i.Author.Id+'" class="text-semibold tms-profile-link">\n                                '+i.Comments[r].Author.Name+"\n                            <\/a>\n                        <\/div>",u+=i.Comments[r].Author.Id==f?'<div>\n                            <button style=\'height:30px; width:30px\' data-editable-name="btnEditComment" data-id="'+i.Comments[r].Id+'" class="float-right bg-white border-0" onclick="TaskModalWorker.MakeCommentFieldEditable(\''+i.Comments[r].Id+'\')">\n                                <i class="fa fa-pencil-square-o" aria-hidden="true"><\/i>\n                            <\/button>\n                        <\/div>\n                        <\/div>':"<\/div>",u+='<div id="'+i.Comments[r].Id+'">'+i.Comments[r].Comment+"<\/div>\n                        \n                    <\/div>\n                  <\/div>";u+="<\/div>";document.getElementById(t).innerHTML=u},n.ClearContent=function(){document.getElementsByName("Comment")[0].value="";document.getElementById("dayTaskModalTitle").innerHTML="";for(var n=document.getElementsByClassName("media-block");n[0];)n[0].remove()},n.MakeCommentFieldEditable=function(n){var t=document.getElementById(n).innerHTML;$("[data-editable-name='btnEditComment']").attr("hidden","hidden");document.getElementById(n).innerHTML='<textarea class="form-control" name="edit.Comment" rows="2">'+t+'<\/textarea>\n                <button class="btn btn-sm btn-editable float-right m-1" data-editable-cancel="'+n+'" \n                        onclick="TaskModalWorker.ResetCommentChanges(\''+n+"','"+t+'\')">\n                    <i class="fas fa-times"><\/i>\n                <\/button>\n\n                <button class="btn btn-sm btn-editable float-right mt-1 tms-update-comment-btn" data-comment-id="'+n+'">\n                    <i class="fas fa-check"><\/i>\n                <\/button>';document.querySelector('[data-id="'+n+'"]').setAttribute("hidden","hidden")},n.ResetCommentChanges=function(n,t){document.getElementById(""+n).innerHTML=""+t;$("[data-editable-name='btnEditComment']").removeAttr("hidden")},n}(),TmsOnPageInitor=function(){function n(){}return n.Init=function(){var t,n=window["tms-filter"],i;console.log("TmsOnPageInitor.Init",n);ScheduleWorker.Constructor(n);i={Tasks:null,User:null,IsAdmin:!1,MyUserId:(t=AccountWorker.User)===null||t===void 0?void 0:t.Id,OpenTaskId:null,SearchModel:n};DayTasksWorker.Constructor(i);ScheduleStaticHandlers.Filter=n;document.addEventListener("DOMContentLoaded",function(){DayTasksWorker.GetTasks();$("#usersSelect").select2().on("change",function(){ScheduleStaticHandlers.OnUsersSelectChanged()})});$("body").tooltip({selector:"[data-toggle=tooltip]"})},n}();TmsOnPageInitor.Init();